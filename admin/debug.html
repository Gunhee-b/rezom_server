<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin API Debug</title>
</head>
<body>
    <h1>Admin API Debug Tool</h1>
    <div>
        <h2>Test Admin Question Creation</h2>
        <button onclick="testLogin()">1. Login as Admin</button>
        <button onclick="testQuestionCreation()">2. Test Question Creation</button>
        <button onclick="checkTokens()">3. Check Tokens</button>
        <div id="results" style="margin-top: 20px; padding: 10px; background: #f5f5f5; font-family: monospace; white-space: pre-wrap;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let accessToken = null;

        function log(message) {
            const results = document.getElementById('results');
            results.textContent += new Date().toISOString() + ': ' + message + '\n';
            console.log(message);
        }

        function readCookie(name) {
            const m = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
            return m ? decodeURIComponent(m[1]) : undefined;
        }

        async function testLogin() {
            log('üîê Testing login...');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@rezom.org',
                        password: 'Admin!2345'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    accessToken = data.accessToken;
                    log('‚úÖ Login successful!');
                    log('Access token: ' + accessToken.substring(0, 20) + '...');
                    log('All cookies: ' + document.cookie);
                } else {
                    log('‚ùå Login failed: ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                log('‚ùå Login error: ' + error.message);
            }
        }

        async function checkTokens() {
            log('üîç Checking tokens...');
            log('Access token: ' + (accessToken ? accessToken.substring(0, 20) + '...' : 'NULL'));
            log('CSRF cookie: ' + (readCookie('X-CSRF-Token') || 'NULL'));
            log('Refresh cookie: ' + (readCookie('rezom_rt') ? 'EXISTS' : 'NULL'));
            log('All cookies: ' + document.cookie);
        }

        async function testQuestionCreation() {
            log('üìù Testing question creation...');
            
            if (!accessToken) {
                log('‚ùå No access token! Please login first.');
                return;
            }

            const csrfToken = readCookie('X-CSRF-Token');
            if (!csrfToken) {
                log('‚ùå No CSRF token found in cookies!');
                return;
            }

            log('üì§ Sending request with:');
            log('- Access token: ' + accessToken.substring(0, 20) + '...');
            log('- CSRF token: ' + csrfToken.substring(0, 10) + '...');

            try {
                const response = await fetch(`${API_BASE}/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: 'Debug Test Question',
                        content: 'Testing question creation from debug tool',
                        conceptSlug: 'language-definition',
                        keywords: ['Innovation'],
                        tags: ['debug-test'],
                        setDaily: false
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Question created successfully!');
                    log('Response: ' + JSON.stringify(data, null, 2));
                } else {
                    log('‚ùå Question creation failed:');
                    log('Status: ' + response.status);
                    log('Response: ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                log('‚ùå Request error: ' + error.message);
            }
        }

        // Clear results on page load
        document.getElementById('results').textContent = 'Ready for testing...\n';
    </script>
</body>
</html>